---
import { getCollection } from "astro:content";

const collection = (await getCollection("work")).sort(
  (a, b) =>
    new Date(b.data.dateStart).valueOf() - new Date(a.data.dateStart).valueOf()
);

// sorted from most recent to oldest
const work = await Promise.all(
  collection.map(async (item) => {
    const { Content } = await item.render();
    return { ...item, Content };
  })
);

const oldestDate = work[work.length - 1].data.dateStart;
const currentDate = new Date();

// Calculate total months from oldest to latest
const oldestYear = oldestDate.getFullYear();
const oldestMonth = oldestDate.getMonth();
const latestYear = currentDate.getFullYear();
const latestMonth = currentDate.getMonth();

const totalMonths =
  (latestYear - oldestYear) * 12 + (latestMonth - oldestMonth) + 1;

// Helper function to calculate month position from current date (top of grid)
const getMonthPosition = (date: Date) => {
  const year = date.getFullYear();
  const month = date.getMonth();
  return (latestYear - year) * 12 + (latestMonth - month) + 1;
};

// Generate year markers with their positions
const differenceInYears = latestYear - oldestYear + 1;
const yearMarkers = Array.from({ length: differenceInYears }, (_, index) => {
  const year = latestYear - index;
  // Calculate which month row this year starts at (from the top)
  const monthsFromTop = (latestYear - year) * 12 + (12 - latestMonth - 1);
  const startRow = monthsFromTop;
  const span =
    year === latestYear
      ? latestMonth + 1
      : year === oldestYear
        ? 12 - oldestMonth
        : 12;
  return { year, startRow, span };
});
---

<div
  class="relative grid grid-cols-[auto_1fr] gap-2"
  style={`--rows: ${totalMonths}; --month-height: 3px; --gap-y: 4px;`}
  data-id="calendar"
>
  <div
    data-id="timeline"
    class="grid grid-rows-[repeat(var(--rows),var(--month-height))] gap-y-(--gap-y)"
  >
    {
      yearMarkers.map(({ year, startRow, span }) => (
        <span
          class="flex justify-end pr-2"
          style={`grid-row: ${startRow} / span ${span};`}
        >
          {year}
        </span>
      ))
    }
  </div>
  <div class="grid col-2" data-id="day">
    <div
      class="grid grid-rows-[repeat(var(--rows),var(--month-height))] gap-y-(--gap-y)"
    >
      {
        work.map((entry) => {
          // Calculate month positions from the current date (top of grid = row 1)
          const endDate =
            entry.data.dateEnd === "Current" ? currentDate : entry.data.dateEnd;
          const endMonth = getMonthPosition(endDate);
          const startMonth = getMonthPosition(entry.data.dateStart);

          return (
            <div
              class="flex ring-1 px-2 py-1 rounded-md gap-2 items-center"
              style={`grid-row: ${endMonth} / ${startMonth + 1};`}
            >
              <div class="font-semibold text-primary">{entry.data.company}</div>
              <div class="text-sm text-secondary">{entry.data.role}</div>
              <div class="text-xs ml-auto">
                {entry.data.dateStart.toLocaleString("default", {
                  month: "short",
                })}
                {" - "}
                {entry.data.dateEnd === "Current"
                  ? "Current"
                  : entry.data.dateEnd.toLocaleString("default", {
                      month: "short",
                    })}
              </div>
            </div>
          );
        })
      }
    </div>
  </div>
</div>
