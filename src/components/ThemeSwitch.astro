---
import { Monitor, Moon, Sun } from "@lucide/astro";
---

<div
  class="flex items-center text-secondary *:hover:text-primary *:p-2 *:hover:bg-interactive *:transition-colors *:rounded-sm gap-2"
>
  <button
    id="themeReset"
    class="hidden group"
    aria-label="Reset to system theme"
  >
    <Monitor
      class="transition-all fill-transparent group-hover:fill-current"
      size="16"
    />
  </button>
  <button class="group" id="themeToggle" aria-label="Toggle theme">
    <Sun
      class="dark:hidden fill-transparent transition-all group-hover:fill-current group-hover:rotate-24"
      size="16"
    />
    <Moon
      class="hidden dark:block fill-transparent transition-all group-hover:fill-current group-hover:rotate-24"
      size="16"
    />
  </button>
</div>

<script is:inline>
  const THEME_KEY = "rsm-theme";

  function getSystemTheme() {
    return window.matchMedia("(prefers-color-scheme: dark)").matches
      ? "dark"
      : "light";
  }

  function applyTheme(theme) {
    if (theme === "dark") {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  }

  function updateResetButton(show) {
    const resetBtn = document.getElementById("themeReset");
    if (resetBtn) {
      if (show) {
        resetBtn.classList.remove("hidden");
      } else {
        resetBtn.classList.add("hidden");
      }
    }
  }

  function init() {
    // Initialize theme
    let userTheme;
    try {
      userTheme = localStorage?.getItem(THEME_KEY);
    } catch (e) {
      userTheme = null;
    }

    if (userTheme === "light" || userTheme === "dark") {
      applyTheme(userTheme);
      updateResetButton(true);
    } else {
      // Use system theme
      applyTheme(getSystemTheme());
      updateResetButton(false);
    }
    // Toggle theme
    document.getElementById("themeToggle")?.addEventListener("click", () => {
      const isDark = document.documentElement.classList.contains("dark");
      const newTheme = isDark ? "light" : "dark";
      applyTheme(newTheme);
      try {
        localStorage.setItem(THEME_KEY, newTheme);
      } catch (e) {
        // Ignore localStorage errors
      }
      updateResetButton(true);
    });

    // Reset to system theme
    document.getElementById("themeReset")?.addEventListener("click", () => {
      try {
        localStorage.removeItem(THEME_KEY);
      } catch (e) {
        // Ignore localStorage errors
      }
      applyTheme(getSystemTheme());
      updateResetButton(false);
    });
  }

  document.addEventListener("DOMContentLoaded", () => init());
  document.addEventListener("astro:after-swap", () => init());
</script>
